OS=$(shell uname)

JAVA_HOME=/usr/lib/jvm/jdk-13
JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
JAVA_HOME=/home/gfrost/corretto/amazon-corretto-11.0.7.10.1-linux-x64

build: test

info:
	@echo OS=${OS}
	@echo JAVA_HOME=${JAVA_HOME}

clean:
	${RM} -rf build 

build/org.grfstuff.compiler:
	mkdir -p build/org.grfstuff.compiler
	${JAVA_HOME}/bin/javac\
      -g \
      -d build/org.grfstuff.compiler\
		--add-modules jdk.internal.vm.ci\
		--add-exports jdk.internal.vm.ci/jdk.vm.ci.code=jdk.internal.vm.compiler\
		--add-exports jdk.internal.vm.ci/jdk.vm.ci.common=jdk.internal.vm.compiler\
      --add-exports jdk.internal.vm.ci/jdk.vm.ci.hotspot=jdk.internal.vm.compiler\
      --patch-module jdk.internal.vm.compiler=org.grfstuff.compiler/src/main/java\
      $(shell find org.grfstuff.compiler/src/main/java -name *.java | grep -v module-info)


build/org.grfstuff.violajones: 
	mkdir -p build/org.grfstuff.violajones
	${JAVA_HOME}/bin/javac -g \
      -d build/org.grfstuff.violajones\
      --source-path org.grfstuff.violajones/src/main/java\
      $(shell find org.grfstuff.violajones/src/main/java -name *.java)

test: clean build/org.grfstuff.compiler build/org.grfstuff.violajones
	${JAVA_HOME}/bin/java \
      -XX:+UnlockExperimentalVMOptions -XX:+UseJVMCICompiler -XX:-TieredCompilation\
      -XX:CompileCommand=compileonly,org/grfstuff/violajones/ViolaJones.compute\
      -XX:CompileCommand=compileonly,org/grfstuff/violajones/ViolaJOnes.run\
       --patch-module jdk.internal.vm.compiler=build/org.grfstuff.compiler\
		 -Dbackend.factory=org.grfstuff.compiler.GrfStuffHotSpotBackendFactory\
		 -classpath build/org.grfstuff.violajones\
      org.grfstuff.violajones.ViolaJones

